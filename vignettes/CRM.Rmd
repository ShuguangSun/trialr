---
title: "Continual Reassessment Method in `trialr`"
author: "Kristian Brock"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
bibliography: library.bib
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The Continual Reassessment Method is the grand archduke of adaptive clinical trials.
Originally published by @OQuigley1990, it assumes a smooth mathematical form for the dose-toxicity curve to conduct a dose-finding trial seeking a maximum tolerable dose.
It is a truly seminal design, with many variants appearing over the years to handle different clinical scenarios, such as seperate groups, late-onset toxicity, efficacy and toxicity outcomes, etc.

In this vignette, we focus on the original Bayesian MTD-seeking design in one homogeneous group.
Let $x_i$ be a standardised dose-level. 
The probability of DLT at dose $x_i$ is estimated to be $F(x_i, \theta)$, where $F$ is the smooth mathematical function, and $\theta$ is a general vector of parameters.
Even within this simple scenario, there are variants that use different forms for $F$, and different distributions on $\theta$.

The CRM variants currently implemented in `trialr` for MTD-finding in a single homogeneous group are:

| `trialr` model | Link Function | Parameters |
| ------------- |:-------------:| -----:|
| `stanmodels$CrmEmpiricNormalPrior` | $F(x_i, \beta)$ = $x_i^{\exp{\beta}}$ | normal prior on $\beta$; |
| `stanmodels$CrmOneParamLogisticNormalPrior` | $F(x_i, \beta) = 1 / (1 + \exp{(-a_0 - \beta x_i}))$ | $a_0$ fixed and a normal prior on $\beta$ |
| `stanmodels$CrmOneParamLogisticGammaPrior` | $F(x_i, \beta) = 1 / (1 + \exp{(-a_0 - \beta x_i}))$ | $a_0$ fixed and a gamma prior on $\beta$ |
| `stanmodels$CrmTwoParamLogisticNormalPrior` | $F(x_i, \alpha, \beta) = 1 / (1 + \exp{(-\alpha - \beta x_i}))$ | normal priors on $\alpha$ and $\beta$ |

<!-- - `stanmodels$CrmEmpiricNormalPrior`, for the empiric model (aka the power model), $F(x_i, \beta)$ = $x_i^{\exp{\beta}}$, with normal prior on $\beta$; -->
<!-- - `stanmodels$CrmOneParamLogisticNormalPrior`, the one-parameter logistic model, $F(x_i, \beta) = 1 / (1 + \exp{(-a_0 - \beta x_i}))$, with $a_0$ fixed and a normal prior on $\beta$; -->
<!-- - `stanmodels$CrmOneParamLogisticGammaPrior`, the one-parameter logistic model, $F(x_i, \beta) = 1 / (1 + \exp{(-a_0 - \beta x_i}))$, with  $a_0$ fixed and a gamma prior on $\beta$; -->
<!-- - `stanmodels$CrmTwoParamLogisticNormalPrior`, the two-parameter logistic model, $F(x_i, \beta) = 1 / (1 + \exp{(-\alpha - \beta x_i}))$, with normal priors on $\alpha$ and $\beta$; -->

Other variants could easily be added in future, if requested.
For instance, @Cheung2011 defines a model that uses the hyperbolic tangent link function, but we have not implemented it here because we have never required it.

# Usage
Let's conduct some examples. 
We must load `trialr`
```{r, message=FALSE, warning=FALSE}
library(trialr)
```

For illustration, we consider a scenario where we investigate 5 dose-levels seeking the dose with Pr(DLT) closest to 25%.
We will assume that our _skeleton_ (i.e. our prior belief of the dose-toxicity curve) is

```{r}
target <- 0.25
skeleton <- c(0.05, 0.15, 0.25, 0.4, 0.6)
```

Say that we have treated 6 patients at 3 dose-levels:

| Patient | Cohort | Dose-level | DLT |
|:-------:|:------:|:----------:|:---:|
|    1    |   1    |      2     |  0  |
|    2    |   1    |      2     |  0  |
|    3    |   2    |      3     |  0  |
|    4    |   2    |      3     |  0  |
|    5    |   3    |      4     |  1  |
|    6    |   3    |      4     |  1  |

```{r}
doses_given <- c(2, 2, 3, 3, 4, 4)
dlt <- c(0, 0, 0, 0, 1, 1)
```

We update each of our CRM models in this scenario.
We then briefly compare the inferences at the end.

## Empiric model

We collect the data required by the Stan routine in a list.

```{r, results = "hide"}
dat1 <- list(
  a0 = 3,
  beta_sd = sqrt(1.34),
  num_doses = length(skeleton),
  skeleton = skeleton,
  num_patients = length(doses_given),
  tox = dlt,
  doses = doses_given
)
samp1 <- rstan::sampling(stanmodels$CrmEmpiricNormalPrior,
                         data = dat1, seed = 123)
```

We use a fixed intercept value of 3 and a prior variance of $\beta$ equal to 1.34, as used in Cheung.
In this demonstration, we set the seed when sampling for reproducibility but in the wild, you might not do this.

We extract the samples of the posterior probability of DLT at each dose, stored as the series of parameters called `prob_tox`.
From there, all manner of inference is possible.
We can, for example, calculate the posterior expected probability of DLT at each dose as the mean of each sample:

```{r}
prob_tox_samp1 <- as.data.frame(samp1, 'prob_tox')
prob_tox1 <- colMeans(prob_tox_samp1)
prob_tox1
```

We see that dose-level 2 is closest to our toxicity target of 25%.
Having posterior samples is very liberating, for an inferential point of view.
For example, it is trivial to calculate the probability that the toxicity rate exceeds the target DLT probability at each dose:

```{r}
prob_too_toxic1 <- unname(colMeans(prob_tox_samp1 > target))
prob_too_toxic1
```

Even at this early stage, we are quite sure that the top dose is too toxic.


## One parameter logisitic model with normal prior
THis model takes similar parameters to those used before:

```{r}
dat2 <- list(
  a0 = 3,
  beta_mean = 0,
  beta_sd = sqrt(1.34),
  num_doses = length(skeleton),
  skeleton = skeleton,
  num_patients = length(doses_given),
  tox = dlt,
  doses = doses_given
)
```

We then fit the model to the data:

```{r, results = "hide"}
samp2 <- rstan::sampling(stanmodels$CrmOneParamLogisticNormalPrior,
                         data = dat2, seed = 123)
```

and perform some simple post-processing, as before:
```{r}
prob_tox_samp2 <- as.data.frame(samp2, 'prob_tox')
prob_tox2 <- colMeans(prob_tox_samp2)
prob_tox2
```

## One parameter logisitic model with gamma prior
This model requires slightly different parameters, on account of the gamma prior:

```{r}
dat3 <- list(a0 = 3,
             beta_shape = 1,
             beta_inverse_scale = 1,
             num_doses = length(skeleton),
             skeleton = skeleton,
             num_patients = length(doses_given),
             tox = dlt,
             doses = doses_given
)
```

This use of a Gamma(1, 1) prior is the same as an Exponential(1) prior.

```{r, results = "hide"}
samp3 <- rstan::sampling(stanmodels$CrmOneParamLogisticGammaPrior,
                         data = dat3, seed = 123)
```

```{r}
prob_tox_samp3 <- as.data.frame(samp3, 'prob_tox')
prob_tox3 <- colMeans(prob_tox_samp3)
prob_tox3
```


## Two parameter logisitic model with normal priors
TODO

# References
