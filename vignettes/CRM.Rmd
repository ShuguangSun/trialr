---
title: "Continual Reassessment Method in `trialr`"
author: "Kristian Brock"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
bibliography: library.bib
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The Continual Reassessment Method (CRM) is the elder statesman of adaptive clinical trials.
Originally published by @OQuigley1990, it assumes a smooth mathematical form for the dose-toxicity curve to conduct a dose-finding trial seeking a maximum tolerable dose.
It is a truly seminal design, with many variants appearing over the years to handle different clinical scenarios, such as seperate groups, late-onset toxicity, efficacy and toxicity outcomes, and more.

In this vignette, we focus on the original Bayesian MTD-seeking design in one homogeneous group.
Let $x_i$ be a standardised dose-level. 
The probability of _dose-limiting toxicity_ (DLT) at dose $x_i$ is estimated to be $F(x_i, \theta)$, where $F$ is a smooth mathematical function, and $\theta$ is a general vector of parameters.
Even within this simple scenario, there are variants that use different forms for $F$, and different distributions on $\theta$.

The CRM variants currently implemented in `trialr` for MTD-finding in a single homogeneous group are:

| `trialr` model | Link Function | Parameters |
| ------------- |:-------------:| -----:|
| `stanmodels$CrmEmpiricNormalPrior` | $F(x_i, \beta)$ = $x_i^{\exp{\beta}}$ | normal prior on $\beta$; |
| `stanmodels$CrmOneParamLogisticNormalPrior` | $F(x_i, \beta) = 1 / (1 + \exp{(-a_0 - \exp{(\beta)} x_i}))$ | $a_0$ fixed and a normal prior on $\beta$ |
| `stanmodels$CrmOneParamLogisticGammaPrior` | $F(x_i, \beta) = 1 / (1 + \exp{(-a_0 - \exp{(\beta)} x_i)})$ | $a_0$ fixed and a gamma prior on $\beta$ |
| `stanmodels$CrmTwoParamLogisticNormalPrior` | $F(x_i, \alpha, \beta) = 1 / (1 + \exp{(-\alpha - \exp{(\beta)} x_i)})$ | normal priors on $\alpha$ and $\beta$ |

In each instance, the slope parameter $\beta$ is exponentiated to ensure a positive value.
One of the core assumptions of the CRM and dose-escalation methods in general, is that the probability of toxicity increases with dose.
If a negative value for $\beta$ is implausible, it makes sense to reflect this in the model.

Other CRM variants could easily be added in future, if requested.
For instance, @Cheung2011 defines a model that uses the hyperbolic tangent link function, but we have not implemented it here because we have never required it.

# Usage
Let's conduct some examples. 

To access the Stan implementations of the CRM, we must load `trialr`:
```{r, message=FALSE, warning=FALSE}
library(trialr)
```

For illustration, we consider a scenario where we investigate 5 dose-levels seeking the dose with Pr(DLT) closest to 25%.
We will assume that our _skeleton_ (i.e. our prior belief of the dose-toxicity curve) is

```{r}
target <- 0.25
skeleton <- c(0.05, 0.15, 0.25, 0.4, 0.6)
```

Say that we have treated 6 patients at 3 dose-levels:

| Patient | Cohort | Dose-level | DLT |
|:-------:|:------:|:----------:|:---:|
|    1    |   1    |      2     |  0  |
|    2    |   1    |      2     |  0  |
|    3    |   2    |      3     |  0  |
|    4    |   2    |      3     |  0  |
|    5    |   3    |      4     |  1  |
|    6    |   3    |      4     |  1  |

```{r}
doses_given <- c(2, 2, 3, 3, 4, 4)
dlt <- c(0, 0, 0, 0, 1, 1)
```

We update each of our CRM models in this scenario.
We then briefly compare the inferences at the end.

## Empiric model

We collect the data required by the Stan routine in a list:

```{r, results = "hide", warning=FALSE, message=FALSE}
dat1 <- list(
  a0 = 3,
  beta_sd = sqrt(1.34),
  num_doses = length(skeleton),
  skeleton = skeleton,
  num_patients = length(doses_given),
  tox = dlt,
  doses = doses_given
)
samp1 <- rstan::sampling(stanmodels$CrmEmpiricNormalPrior,
                         data = dat1, seed = 123)
```

We use a fixed intercept value of 3 and a prior variance of $\beta$ equal to 1.34, as used by Cheung in his examples.
In this demonstration, we set the seed for reproducibility when sampling however, in the wild, you might not do this.

We extract the samples of the posterior probability of DLT at each dose, stored as the series of parameters called `prob_tox`.
From there, all manner of inference is possible.
We can, for example, calculate the posterior expected probability of DLT at each dose as the mean of each sample:

```{r}
prob_tox_samp1 <- as.data.frame(samp1, 'prob_tox')
prob_tox1 <- colMeans(prob_tox_samp1)
prob_tox1
```

We see that dose-level 2 is closest to our toxicity target of 25%.
Having posterior samples is very liberating, for an inferential point of view.
For example, it is trivial to calculate the probability that the toxicity rate exceeds the target DLT probability at each dose:

```{r}
prob_too_toxic1 <- unname(colMeans(prob_tox_samp1 > target))
prob_too_toxic1
```

Even at this early stage, we are quite sure that the top dose is too toxic.


## One parameter logisitic model with normal prior
This model takes similar parameters to those used before:

```{r}
dat2 <- list(
  a0 = 3,
  beta_mean = 0,
  beta_sd = sqrt(1.34),
  num_doses = length(skeleton),
  skeleton = skeleton,
  num_patients = length(doses_given),
  tox = dlt,
  doses = doses_given
)
```

We then fit the model to the data:

```{r, results = "hide", warning=FALSE, message=FALSE}
samp2 <- rstan::sampling(stanmodels$CrmOneParamLogisticNormalPrior,
                         data = dat2, seed = 123)
```

and perform some simple post-processing, as before:
```{r}
prob_tox_samp2 <- as.data.frame(samp2, 'prob_tox')
prob_tox2 <- colMeans(prob_tox_samp2)
prob_tox2
```

## One parameter logisitic model with gamma prior
This model requires slightly different parameters, on account of the gamma prior:

```{r}
dat3 <- list(a0 = 3,
             beta_shape = 1,
             beta_inverse_scale = 1,
             num_doses = length(skeleton),
             skeleton = skeleton,
             num_patients = length(doses_given),
             tox = dlt,
             doses = doses_given
)
```

This use of a Gamma(1, 1) prior is the same as an Exponential(1) prior.

```{r, results = "hide", warning=FALSE, message=FALSE}
samp3 <- rstan::sampling(stanmodels$CrmOneParamLogisticGammaPrior,
                         data = dat3, seed = 123)
```

Generally, divergent transitions are bad news but we will not concern ourselves with the very small number observed here.
Performing the usual post-processing to estimate Pr(DLT):

```{r}
prob_tox_samp3 <- as.data.frame(samp3, 'prob_tox')
prob_tox3 <- colMeans(prob_tox_samp3)
prob_tox3
```

## Two parameter logisitic model with normal priors
We now have two parameters on which to specify priors.
The other parameters stay the same:

```{r}
dat4 <- list(alpha_mean = 0,
             alpha_sd = 1,
             beta_mean = 0,
             beta_sd = sqrt(1.34),
             num_doses = length(skeleton),
             skeleton = skeleton,
             num_patients = length(doses_given),
             tox = dlt,
             doses = doses_given
)
```

The processes of sampling:
```{r, results = "hide"}
samp4 <- rstan::sampling(stanmodels$CrmTwoParamLogisticNormalPrior,
                         data = dat4, seed = 123)
```

and post-processing:

```{r}
prob_tox_samp4 <- as.data.frame(samp4, 'prob_tox')
prob_tox4 <- colMeans(prob_tox_samp4)
prob_tox4
```

remain the same. 
These estimates look different, so let's compare the methods.

## Comparison
Let's compare the posterior estimate of the dose-toxicity curve:

```{r}
post_curves <- data.frame(
  DoseLevel = 1:length(skeleton),
  Empiric = prob_tox1,
  Logit1N = prob_tox2,
  Logit1G = prob_tox3,
  Logit2N = prob_tox4
)
knitr::kable(post_curves, digits = 2)
```

It is perhaps no surprise that the three single-parameter models (`Empiric`, `Logit1N`, & `Logit1G`) provide very similar estimates and agree that the dose closest to the target is dose-level 2.
In contrast, the two-parameter model estimates a steeper curve, and proposes dose-level 3 for the next patient(s).
Let's have a look at that graphically:

```{r, fig.width=7, fig.height=7}
post_curves_tall <- data.frame(
  DoseLevel = rep(1:length(skeleton), times = 4),
  ProbTox = c(prob_tox1, prob_tox2, prob_tox3, prob_tox4),
  Model = rep(c('Empiric', 'Logit1N', 'Logit1G', 'Logit2N'), each = 5)
)

library(ggplot2)
ggplot(post_curves_tall, aes(x = DoseLevel, y = ProbTox, group = Model, col = Model)) + 
  geom_line(size = 1.2) + 
  geom_hline(yintercept = target, col = 'red', linetype = 'dashed')
```

If we suspect that the difference in inference might be driven by our prior for $\alpha$ in the two-parameter model, we can look at a summary of the posterior samples for that parameter:

```{r}
knitr::kable(rstan::summary(samp4, 'alpha')$summary, digits = 2)
```

The posterior mean is not near the tail of the $N(0, 1)$ prior distribution and the posterior 95% credible interval has relocated from prior guess of (-2, 2).
The prior on $\alpha$ does not appear to be unduly driving the divergence from the one-parameter models.

## Are we interested in Pr(DLT) or Pr(MTD)?
The traditional method of inference using the CRM has been to estimate the expected dose-toxicity curve and infer the suggested dose by identifying which is estimated to have toxicity rate closest to the target.

However, with Stan we can take a different approach. 
We have many possible realities sampled from the posterior distributions.
For instance, each Stan-fit samples many possible dose-toxicity curves, in accordance with the model and priors specified and the data observed.
With each sampled dose-toxicity curve we can calculate the dose that is closest to the target.
Each sampled curve advocates a single dose.
We can then tabulate the number of times that each dose is chosen, effectively creating the posterior probability that each dose is the MTD.
This is probably what we really want when we conduct an MTD-seeking clinical trial.

```{r}
prob_mtd1 <- table(apply(prob_tox_samp1, 1, function(x) which.min(abs(x - target)))) / 
  nrow(prob_tox_samp1) 
prob_mtd4 <- table(apply(prob_tox_samp4, 1, function(x) which.min(abs(x - target)))) / 
  nrow(prob_tox_samp4) 
knitr::kable(
  data.frame(
    DoseLevel = 1:length(skeleton),
    ProbMTD1 = as.numeric(prob_mtd1),
    ProbMTD4 = as.numeric(prob_mtd4)
  ), digits = 2
)
```

The empiric model (model 1) is actually relatively ambivalent between the first four dose-levels, assigning each roughly the same probability of being the MTD.
The other one-parameter models are similar (not shown).
In contrast, the two-parameter model is actually more confident in its choice of dose-level 3.
However, none of the models is particularly confident and this should not surprise us as we have only observed 6 patients.

## Other CRM vignettes

Coming soon:

- Visualisation in CRM
- Model choice in CRM



# References
