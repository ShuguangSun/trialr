<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EffTox in trialr • trialr</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">trialr</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/BEBOP.html">BEBOP in PePS2</a>
    </li>
    <li>
      <a href="../articles/EffTox.html">EffTox in trialr</a>
    </li>
    <li>
      <a href="../articles/HierarchicalBayesianResponse.html">Hierarchical Bayesian Model for Binary Responses</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/brockk/trialr">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>EffTox in trialr</h1>
                        <h4 class="author">Kristian Brock</h4>
            
            <h4 class="date">2018-02-18</h4>
          </div>

    
    
<div class="contents">
<div id="recap-of-the-efftox-model" class="section level1">
<h1 class="hasAnchor">
<a href="#recap-of-the-efftox-model" class="anchor"></a>Recap of the EffTox model</h1>
<p>Thall &amp; Cook <span class="citation">(2004)</span> introduced the <em>EffTox</em> design for dose-finding clinical trials where both efficacy and toxicity events guide dose selection decisions. This is in contrast to methods like 3+3 and CRM <span class="citation">(O’Quigley, Pepe, and Fisher 1990)</span>, where dose selection is determined by toxicity events only. We provide a brief recap of EffTox here, but full details are given in <span class="citation">(Thall and Cook 2004; Thall, Cook, and Estey 2006; Thall et al. 2014)</span>.</p>
<p>For doses <span class="math inline">\(\boldsymbol{y} = (y_1, ..., y_n)\)</span>, the authors define codified doses <span class="math inline">\((x_1, ..., x_n)\)</span> using the transform</p>
<p><span class="math inline">\(x_i = \log{y_i} - \sum_{j=1}^n \frac{\log{y_j}}{n}\)</span></p>
<p>The codified doses are used as the sole explanatory variables in logit models for the marginal probabilities of toxicity and efficacy:</p>
<p><span class="math inline">\(\text{logit } \pi_T = \alpha + \beta x\)</span></p>
<p><span class="math inline">\(\text{logit } \pi_E = \gamma + \zeta x + \eta x^2\)</span></p>
<p>and the joint probability is modelled using the function</p>
<p><span class="math inline">\(\pi_{a,b} = (\pi_E)^a (1-\pi_E)^{1-a} (\pi_T)^b (1-\pi_T)^{1-b} + (-1)^{a+b} (\pi_E) (1-\pi_E) (\pi_T) (1-\pi_T) \frac{e^\psi-1}{e^\psi+1}\)</span>.</p>
<p>Normal priors are specified for the elements of the parameter vector <span class="math inline">\(\boldsymbol{\theta} = (\alpha, \beta, \gamma, \zeta, \eta, \psi)\)</span>.</p>
<p>At each dose update decision, the dose <span class="math inline">\(x\)</span> is acceptable if</p>
<p><span class="math inline">\(\text{Pr}\left\{ \pi_T(x, \boldsymbol{\theta}) &lt; \overline{\pi}_T | \mathcal{D} \right\} &gt; p_T\)</span></p>
<p>and</p>
<p><span class="math inline">\(\text{Pr}\left\{ \pi_E(x, \boldsymbol{\theta}) &gt; \underline{\pi}_E | \mathcal{D} \right\} &gt; p_E\)</span></p>
<p>and is no more than than one position below the lowest dose-level given and no more than one position above the highest dose-level given. The net effect of these last two criteria is that untried doses may not be skipped in escalation or de-escalation. <span class="math inline">\(\underline{\pi}_E, p_E, \overline{\pi}_T, p_T\)</span> are provided by the user as the trial scenario dictates.</p>
<p>The utility of dose <span class="math inline">\(x\)</span>, with efficacy <span class="math inline">\(\pi_E(x, \boldsymbol{\theta})\)</span> and toxicity <span class="math inline">\(\pi_T(x, \boldsymbol{\theta})\)</span> is</p>
<p><span class="math inline">\(u(\pi_E, \pi_T) = 1 - \left( \left(\frac{1-\pi_E}{1-\pi_{1,E}^*}\right)^p + \left(\frac{\pi_T}{\pi_{2,T}^*}\right)^p \right) ^ \frac{1}{p}\)</span></p>
<p>where <span class="math inline">\(p\)</span> is calculated to intersect the points <span class="math inline">\((\pi_{1,E}^*, 0)\)</span>, <span class="math inline">\((1, \pi_{2,T}^*)\)</span> and <span class="math inline">\((\pi_{3,E}^*, \pi_{3,T}^*)\)</span> in the efficacy-toxicity plain. I refer to these as <em>hinge points</em> but that is not common nomenclature.</p>
<p>At the dose selection decision, the dose-level from the acceptable set with maximal utility is selected to be given to the next patient or cohort. If there are no acceptable doses, the trial stops and no dose is recommended.</p>
<p>There are several published EffTox examples, including explanations and tips on parameter choices <span class="citation">(Thall and Cook 2004, <span class="citation">Thall, Cook, and Estey (2006)</span>, <span class="citation">Thall et al. (2014)</span>)</span>.</p>
<p>The MD Anderson Cancer Center publishes software <span class="citation">(R. Herrick et al. 2015)</span> to perform calculations and simulations for EffTox trials. However, the software is available for Windows in compiled-form only. Thus, trialists cannot run the software on Mac or Linux unless using a virtual machine. Furthermore, trialists may not easily alter the behaviour of the model. Brock et al. (submitted 2017) describe a clinical trial scenario where some alteration of the default model behaviour would have been preferable. It was this that prompted the author to write the open-source implementation provided in ‘trialr’.</p>
</div>
<div id="efftox-in-trialr" class="section level1">
<h1 class="hasAnchor">
<a href="#efftox-in-trialr" class="anchor"></a>EffTox in <code>trialr</code>
</h1>
<p>We will work with the advanced prostate cancer example given in <span class="citation">Thall et al. (2014)</span>. They investigate the five doses 1, 2, 4, 6.6 and 10 mcL/kg, seeking the best dose with</p>
<p><span class="math inline">\(\text{Pr}\left\{ \pi_T(x, \boldsymbol{\theta}) &lt; 0.3 | \mathcal{D} \right\} &gt; 0.1\)</span></p>
<p>and</p>
<p><span class="math inline">\(\text{Pr}\left\{ \pi_E(x, \boldsymbol{\theta}) &gt; 0.5 | \mathcal{D} \right\} &gt; 0.1\)</span></p>
<p>Thus, we have <span class="math inline">\(p_T = p_E = 0.1, \overline{\pi}_T = 0.3\)</span> and <span class="math inline">\(\underline{\pi}_E = 0.5\)</span>.</p>
<p>The parameterisation for this trial is loaded by default in the MD Anderson EffTox app. It can be loaded in <code>trialr</code> using the command</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(trialr)
dat &lt;-<span class="st"> </span><span class="kw"><a href="../reference/efftox_parameters_demo.html">efftox_parameters_demo</a></span>()</code></pre></div>
<p>Their hinge points on the neutral utility curve are (0.5, 0), (1, 0.65) and (0.7, 0.25). The curvature parameter for the utility contours is calculated using</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p &lt;-<span class="st"> </span><span class="kw"><a href="../reference/efftox_solve_p.html">efftox_solve_p</a></span>(<span class="dt">eff0 =</span> <span class="fl">0.5</span>, <span class="dt">tox1 =</span> <span class="fl">0.65</span>, <span class="dt">eff_star =</span> <span class="fl">0.7</span>, <span class="dt">tox_star =</span> <span class="fl">0.25</span>)
p</code></pre></div>
<pre><code>## [1] 0.9773632</code></pre>
<p>The utility curves in this particular example have curvature parameter <span class="math inline">\(p \approx 0.977\)</span>.</p>
<p>We fetched the <code>dat</code> object above by calling <code>efftox_parameters_demo</code>. That function is provided for convenience. It is just shorthand for</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat &lt;-<span class="st"> </span><span class="kw">list</span>(
  <span class="dt">num_doses =</span> <span class="dv">5</span>,
  <span class="dt">real_doses =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">4</span>, <span class="fl">6.6</span>, <span class="dv">10</span>),
  <span class="dt">efficacy_hurdle =</span> <span class="fl">0.5</span>,
  <span class="dt">toxicity_hurdle =</span> <span class="fl">0.3</span>,
  <span class="dt">p_e =</span> <span class="fl">0.1</span>,
  <span class="dt">p_t =</span> <span class="fl">0.1</span>,
  <span class="dt">p =</span> p,
  <span class="dt">eff0 =</span> <span class="fl">0.5</span>,
  <span class="dt">tox1 =</span> <span class="fl">0.65</span>,
  <span class="dt">eff_star =</span> <span class="fl">0.7</span>,
  <span class="dt">tox_star =</span> <span class="fl">0.25</span>,
  
  <span class="dt">alpha_mean =</span> <span class="op">-</span><span class="fl">7.9593</span>, <span class="dt">alpha_sd =</span> <span class="fl">3.5487</span>,
  <span class="dt">beta_mean =</span> <span class="fl">1.5482</span>, <span class="dt">beta_sd =</span> <span class="fl">3.5018</span>,
  <span class="dt">gamma_mean =</span> <span class="fl">0.7367</span>, <span class="dt">gamma_sd =</span> <span class="fl">2.5423</span>,
  <span class="dt">zeta_mean =</span> <span class="fl">3.4181</span>, <span class="dt">zeta_sd =</span> <span class="fl">2.4406</span>,
  <span class="dt">eta_mean =</span> <span class="dv">0</span>, <span class="dt">eta_sd =</span> <span class="fl">0.2</span>,
  <span class="dt">psi_mean =</span> <span class="dv">0</span>, <span class="dt">psi_sd =</span> <span class="dv">1</span>,
  
  <span class="dt">eff =</span> <span class="kw">c</span>(),
  <span class="dt">tox =</span> <span class="kw">c</span>(),
  <span class="dt">doses =</span> <span class="kw">c</span>(),
  <span class="dt">num_patients =</span> <span class="dv">0</span>
)</code></pre></div>
<p>Refer to the published paper for information on the normal priors.</p>
<p>To study the method, let us say that we have treated six patients in two cohorts of three at dose-levels 1 and 2 respectively. Let us also say we observe no toxicities and one efficacy event in cohort 1, and one toxicity and two efficacies in cohort 2. We record this information in the <code>dat</code> object that is eventually passed to <code>rstan</code> to perform posterior sampling.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat<span class="op">$</span>doses =<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>)
dat<span class="op">$</span>tox   =<span class="st"> </span><span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>)
dat<span class="op">$</span>eff   =<span class="st"> </span><span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>)
dat<span class="op">$</span>num_patients =<span class="st"> </span><span class="dv">6</span></code></pre></div>
<p>This completes the information required by EffTox to calculate the next dose. We invoke the prior-to-posterior analysis by calling the <code><a href="http://www.rdocumentation.org/packages/rstan/topics/stanmodel-method-sampling">rstan::sampling</a></code> function with the pre-compiled EffTox stanmodel<a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a> in <code>trialr</code> and our data list. We set the seed for reproducibility.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">samp &lt;-<span class="st"> </span>rstan<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/rstan/topics/stanmodel-method-sampling">sampling</a></span>(stanmodels<span class="op">$</span>EffTox, <span class="dt">data =</span> dat, <span class="dt">seed =</span> <span class="dv">123</span>)</code></pre></div>
<pre><code>## trying deprecated constructor; please alert package maintainer</code></pre>
<p>The call to <code>rstan:sampling</code> prints logging information to the standard out stream. It has been suppressed here for brevity.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x &lt;-<span class="st"> </span><span class="kw"><a href="../reference/efftox_process.html">efftox_process</a></span>(dat, samp)</code></pre></div>
<p>The call to <code>efftox_process</code> extracts the most pertinent information from the sampling object.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x<span class="op">$</span>recommended_dose</code></pre></div>
<pre><code>## [1] 3</code></pre>
<p>We see that dose-level 3 is recommended for the next cohort.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">knitr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/knitr/topics/kable">kable</a></span>(<span class="kw"><a href="../reference/efftox_analysis_to_df.html">efftox_analysis_to_df</a></span>(x), <span class="dt">digits =</span> <span class="dv">3</span>)</code></pre></div>
<table class="table">
<caption>ProbEff and ProbTox are the probabilities of efficacy and toxicity at each dose. ProbAccEff is the probability that the efficacy rate exceeds the desired threshold and ProbAccTox the probability that the toxicity rate is less than the threshold. All probabilities are posterior means.</caption>
<thead><tr class="header">
<th align="left">DoseLevel</th>
<th align="right">ProbEff</th>
<th align="right">ProbTox</th>
<th align="right">ProbAccEff</th>
<th align="right">ProbAccTox</th>
<th align="right">Utility</th>
<th align="left">Acceptable</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">1</td>
<td align="right">0.309</td>
<td align="right">0.090</td>
<td align="right">0.182</td>
<td align="right">0.917</td>
<td align="right">-0.532</td>
<td align="left">TRUE</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="right">0.631</td>
<td align="right">0.100</td>
<td align="right">0.769</td>
<td align="right">0.921</td>
<td align="right">0.099</td>
<td align="left">TRUE</td>
</tr>
<tr class="odd">
<td align="left">3</td>
<td align="right">0.834</td>
<td align="right">0.215</td>
<td align="right">0.924</td>
<td align="right">0.728</td>
<td align="right">0.327</td>
<td align="left">TRUE</td>
</tr>
<tr class="even">
<td align="left">4</td>
<td align="right">0.885</td>
<td align="right">0.304</td>
<td align="right">0.935</td>
<td align="right">0.630</td>
<td align="right">0.292</td>
<td align="left">FALSE</td>
</tr>
<tr class="odd">
<td align="left">5</td>
<td align="right">0.905</td>
<td align="right">0.359</td>
<td align="right">0.937</td>
<td align="right">0.581</td>
<td align="right">0.246</td>
<td align="left">FALSE</td>
</tr>
</tbody>
</table>
<p>This confirms that dose-level 3 has maximal utility. We see that dose-levels 4 and 5 are unacceptable. This is because dose-level 3 has not yet been given. No doses are inferred to be too toxic or inefficacious yet.</p>
<p>We can produce contour plots.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/efftox_contour_plot.html">efftox_contour_plot</a></span>(dat, <span class="dt">prob_eff =</span> x<span class="op">$</span>prob_eff, <span class="dt">prob_tox =</span> x<span class="op">$</span>prob_tox)
<span class="kw">title</span>(<span class="st">'EffTox utility contours'</span>)</code></pre></div>
<div class="figure">
<img src="EffTox_files/figure-html/unnamed-chunk-10-1.png" alt="Utility contours after observing outcomes 1NEN 2NBE." width="576"><p class="caption">
Utility contours after observing outcomes 1NEN 2NBE.
</p>
</div>
<p>The blue stars show the location of the hinge points on the neutral-uility (u=0) contour. The red numbers show the posterior means of the five dose-levels. Doses that are closer to the lower-right corner have higher utility. We see that dose-level 3 has the highest utility.</p>
<p>We can also produce posterior density plots of the dose utilities. For illustration, we will just plot the densities of the three acceptable doses. The package <code>ggplot2</code> is required.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/efftox_utility_density_plot.html">efftox_utility_density_plot</a></span>(samp, <span class="dt">doses =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>) <span class="op">+</span>
<span class="st">  </span>ggplot2<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/labs">ggtitle</a></span>(<span class="st">"EffTox dose utility densities"</span>)</code></pre></div>
<div class="figure">
<img src="EffTox_files/figure-html/unnamed-chunk-11-1.png" alt="Utility densities after observing outcomes 1NEN 2NBE." width="576"><p class="caption">
Utility densities after observing outcomes 1NEN 2NBE.
</p>
</div>
<p>To further facilitate the analysis of dose utility, we provide means of calculating the dose superiority matrix.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">knitr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/knitr/topics/kable">kable</a></span>(<span class="kw"><a href="../reference/efftox_superiority.html">efftox_superiority</a></span>(samp), <span class="dt">digits =</span> <span class="dv">2</span>, <span class="dt">row.names =</span> <span class="ot">TRUE</span>)</code></pre></div>
<table class="table">
<thead><tr class="header">
<th></th>
<th align="right">1</th>
<th align="right">2</th>
<th align="right">3</th>
<th align="right">4</th>
<th align="right">5</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>1</td>
<td align="right">NA</td>
<td align="right">0.92</td>
<td align="right">0.86</td>
<td align="right">0.82</td>
<td align="right">0.80</td>
</tr>
<tr class="even">
<td>2</td>
<td align="right">0.08</td>
<td align="right">NA</td>
<td align="right">0.75</td>
<td align="right">0.68</td>
<td align="right">0.64</td>
</tr>
<tr class="odd">
<td>3</td>
<td align="right">0.14</td>
<td align="right">0.25</td>
<td align="right">NA</td>
<td align="right">0.58</td>
<td align="right">0.54</td>
</tr>
<tr class="even">
<td>4</td>
<td align="right">0.18</td>
<td align="right">0.32</td>
<td align="right">0.42</td>
<td align="right">NA</td>
<td align="right">0.52</td>
</tr>
<tr class="odd">
<td>5</td>
<td align="right">0.20</td>
<td align="right">0.36</td>
<td align="right">0.46</td>
<td align="right">0.48</td>
<td align="right">NA</td>
</tr>
</tbody>
</table>
<p>The element in row <span class="math inline">\(i\)</span> and column <span class="math inline">\(j\)</span> shows <span class="math inline">\(\text{Prob(}u_j &gt; u_i | \text{data)}\)</span>, where <span class="math inline">\(u_k\)</span> is the utility of dose <span class="math inline">\(k\)</span>. We can be quite confident that dose 3 has higher utility than doses 1 and 2. In contrast, the model is much more vague about which is the superior of doses 3, 4 and 5. More data may be illuminating.</p>
</div>
<div id="simulation" class="section level1">
<h1 class="hasAnchor">
<a href="#simulation" class="anchor"></a>Simulation</h1>
<p>We also provide a way to simulate EffTox trial scenarios. Simulation allows trialists to assess the performance of their design.</p>
<p>In addition to the parameters already described, the user must provide the true probabilities of efficacy and toxicity at each dose, and a vector of desired cohort sizes. For illustration, we simulate Scenario 1 under contour <span class="math inline">\(C_2\)</span> in Table 1 of <span class="citation">Thall et al. (2014)</span>. They use the EffTox parameterisation described above to investigate performance under true efficacy probabilities (0.2, 0.4, 0.6, 0.8, 0.9) and toxicity probabilities (0.05, 0.1, 0.15, 0.2, 0.4).</p>
<p>The preferable dose is calculated after the evaluation of each cohort and the following cohort is treated at the dose recommended. We provide the desired cohort sizes as a vector of integers via the <code>cohort_sizes</code> parameter. In the Thall example, they treat a maximum of 39 patients in thirteen cohorts of 3, thus we use <code>cohort_sizes = rep(3, 13)</code>.</p>
<p>In the <code>trialr</code> EffTox implementation, the cohort sizes need not be constant. We can specify different cohort sizes, an option not possible in the official EffTox software. For instance, the investigators might want to re-evaluate the ideal dose after every patient in the early trial stages, where information is scarce. However, once a certain number of patient outcomes have been observed, they might prefer to revert to cohorts of three to avoid unnecessarily frequent analyses. To analyse the dose after each patient for the first 9 patients, followed by ten cohorts of three, we could use <code>cohort_sizes = c(rep, 1, 9), rep(3, 10))</code>.</p>
<p>Once again, we need a list of data to pass to the RStan sampler.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat &lt;-<span class="st"> </span><span class="kw">list</span>(
  <span class="dt">num_doses =</span> <span class="dv">5</span>,
  <span class="dt">real_doses =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">4</span>, <span class="fl">6.6</span>, <span class="dv">10</span>),
  <span class="dt">efficacy_hurdle =</span> <span class="fl">0.5</span>,
  <span class="dt">toxicity_hurdle =</span> <span class="fl">0.3</span>,
  <span class="dt">p_e =</span> <span class="fl">0.1</span>,
  <span class="dt">p_t =</span> <span class="fl">0.1</span>,
  <span class="dt">p =</span> p,
  <span class="dt">eff0 =</span> <span class="fl">0.5</span>,
  <span class="dt">tox1 =</span> <span class="fl">0.65</span>,
  <span class="dt">eff_star =</span> <span class="fl">0.7</span>,
  <span class="dt">tox_star =</span> <span class="fl">0.25</span>,

  <span class="dt">alpha_mean =</span> <span class="op">-</span><span class="fl">7.9593</span>, <span class="dt">alpha_sd =</span> <span class="fl">3.5487</span>,
  <span class="dt">beta_mean =</span> <span class="fl">1.5482</span>, <span class="dt">beta_sd =</span> <span class="fl">3.5018</span>,
  <span class="dt">gamma_mean =</span> <span class="fl">0.7367</span>, <span class="dt">gamma_sd =</span> <span class="fl">2.5423</span>,
  <span class="dt">zeta_mean =</span> <span class="fl">3.4181</span>, <span class="dt">zeta_sd =</span> <span class="fl">2.4406</span>,
  <span class="dt">eta_mean =</span> <span class="dv">0</span>, <span class="dt">eta_sd =</span> <span class="fl">0.2</span>,
  <span class="dt">psi_mean =</span> <span class="dv">0</span>, <span class="dt">psi_sd =</span> <span class="dv">1</span>,

  <span class="dt">doses =</span> <span class="kw">c</span>(),
  <span class="dt">tox   =</span> <span class="kw">c</span>(),
  <span class="dt">eff   =</span> <span class="kw">c</span>(),
  <span class="dt">num_patients =</span> <span class="dv">0</span>
)</code></pre></div>
<p>The elements in <code>dat</code> reflect the point from which each simulated trial iteration will commence. Note that <code>num_patients</code>, <code>doses</code>, <code>tox</code> and <code>eff</code> convey that no patients have yet been observed. This is not a constraint. Unlike the official EffTox software, users may simulate the commencement of a partially-observed EffTox trial by tailoring these four items. To simulate trials starting from a blank canvas, these four elemnts should be set as shown above.</p>
<p>The following code will run a simulation.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">123</span>)
sims =<span class="st"> </span><span class="kw"><a href="../reference/efftox_simulate.html">efftox_simulate</a></span>(dat, <span class="dt">num_sims =</span> <span class="dv">100</span>, <span class="dt">first_dose =</span> <span class="dv">1</span>, 
                       <span class="dt">true_eff =</span> <span class="kw">c</span>(<span class="fl">0.20</span>, <span class="fl">0.40</span>, <span class="fl">0.60</span>, <span class="fl">0.80</span>, <span class="fl">0.90</span>),
                       <span class="dt">true_tox =</span> <span class="kw">c</span>(<span class="fl">0.05</span>, <span class="fl">0.10</span>, <span class="fl">0.15</span>, <span class="fl">0.20</span>, <span class="fl">0.40</span>),
                       <span class="dt">cohort_sizes =</span> <span class="kw">rep</span>(<span class="dv">3</span>, <span class="dv">13</span>))</code></pre></div>
<p>The doses recommended at the end of each simulated trial are recorded in the <code>recommended_dose</code> slot of the <code>sims</code> object. For instance, infer from the simulated trials the probability that each dose will be recommended using</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">table</span>(sims<span class="op">$</span>recommended_dose) <span class="op">/</span><span class="st"> </span><span class="kw">length</span>(sims<span class="op">$</span>recommended_dose)</code></pre></div>
<p>Similarly, you can calculate the probability of each dose being given to a random patient using</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">table</span>(<span class="kw">unlist</span>(sims<span class="op">$</span>doses_given)) <span class="op">/</span><span class="st"> </span><span class="kw">length</span>(<span class="kw">unlist</span>(sims<span class="op">$</span>doses_given))</code></pre></div>
<p>and the mean number of patients being treated at each dose-level in each simulation</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">table</span>(<span class="kw">unlist</span>(sims<span class="op">$</span>doses_given)) <span class="op">/</span><span class="st"> </span><span class="kw">length</span>(sims<span class="op">$</span>recommended_dose)</code></pre></div>
<div id="simulation-speed" class="section level2">
<h2 class="hasAnchor">
<a href="#simulation-speed" class="anchor"></a>Simulation speed</h2>
<p>The call to <code>efftox_simulate</code> will take about 25 minutes to run 100 iterations. This is much slower than the official Windows EffTox app, which would typically take a number of seconds rather than minutes. The official app is written in C++ and uses a fast numerical method for resolving Bayesian integrals with Gaussian priors called <em>spherical radial integration</em>, presented by Monahan &amp; Genz <span class="citation">(1997)</span>. In contrast, <code>trialr</code> delegates posterior sampling to <code>rstan</code>. The time it takes to run simulated EffTox trials in <code>trialr</code> is largely driven by the time it takes to run <code><a href="http://www.rdocumentation.org/packages/rstan/topics/stanmodel-method-sampling">rstan::sampling</a></code> many times. We are observing that MCMC is generally slower than spherical radial integration. However, it is also much more flexible. The trialr implementation of EffTox is easy to customise. Any aspect of the probability model may be changed by altering our open-source implementation. Non-normal priors may be used without any obligation to re-implement the prior-to-posterior analysis method. RStan handles the general model specification, rather than optimising for particular circumstances.</p>
<p>The process of simulating dose-finding trials is relatively computationally intensive because the dose update decision is made at the end of each cohort. In the above scenario, the dose decision is performed up to 13 times per iteration. When calling <code><a href="http://www.rdocumentation.org/packages/rstan/topics/stanmodel-method-sampling">rstan::sampling</a></code>, 4 chains of 2000 draws are used by default. Thus, 100 iterations of the above scenario involves <span class="math inline">\(100 \times 13 \times 4 = 5200\)</span> chains sampled from the posterior distribution. Thus, if each call takes a fraction of a second (a sampled chain takes approximately 0.3s on my computer), the aggregate run-time is of the order of 20-30 minutes. Users can alter the number of chains used, the number of points per chain, and the amount of thinning by providing extra parameters via the ellipsis operator to <code>efftox_simulate</code>. These will then be forwarded to the <code><a href="http://www.rdocumentation.org/packages/rstan/topics/stanmodel-method-sampling">rstan::sampling</a></code> function.</p>
<p>Simulation is a costly exercise! Striking the balance between speed and flexibility is difficult. Sometimes a slow, flexibile method will be preferable to a fast, fixed method. It pays to hone parameters on small exploratory batches and commit to large jobs when ready.</p>
</div>
</div>
<div id="trialr" class="section level1">
<h1 class="hasAnchor">
<a href="#trialr" class="anchor"></a>trialr</h1>
<p><code>trialr</code> is available at <a href="https://github.com/brockk/trialr" class="uri">https://github.com/brockk/trialr</a></p>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<div id="refs" class="references">
<div id="ref-EffTox">
<p>Herrick, R, C Norris, JD Cook, and J Venier. 2015. “EffTox.” MD Anderson Cancer Center. <a href="https://biostatistics.mdanderson.org/softwaredownload/SingleSoftware.aspx?Software%7B%5C_%7DId=2" class="uri">https://biostatistics.mdanderson.org/softwaredownload/SingleSoftware.aspx?Software{\_}Id=2</a>.</p>
</div>
<div id="ref-Monahan1997">
<p>Monahan, John, and Alan Genz. 1997. “Spherical-Radial Integration Rules for Bayesian Computation.” <em>Journal of the American Statistical Association</em> 92 (438): 664–74. <a href="http://www.jstor.org/stable/2965714" class="uri">http://www.jstor.org/stable/2965714</a>.</p>
</div>
<div id="ref-OQuigley1990">
<p>O’Quigley, J, M Pepe, and L Fisher. 1990. “Continual reassessment method: a practical design for phase 1 clinical trials in cancer.” <em>Biometrics</em> 46 (1): 33–48. doi:<a href="https://doi.org/10.2307/2531628">10.2307/2531628</a>.</p>
</div>
<div id="ref-Thall2004">
<p>Thall, PF, and JD Cook. 2004. “Dose-Finding Based on Efficacy-Toxicity Trade-Offs.” <em>Biometrics</em> 60 (3): 684–93.</p>
</div>
<div id="ref-Thall2006">
<p>Thall, PF, JD Cook, and EH Estey. 2006. “Adaptive dose selection using efficacy-toxicity trade-offs: illustrations and practical considerations.” <em>Journal of Biopharmaceutical Statistics</em> 16 (5): 623–38. doi:<a href="https://doi.org/10.1080/10543400600860394">10.1080/10543400600860394</a>.</p>
</div>
<div id="ref-Thall2014">
<p>Thall, PF, RC Herrick, HQ Nguyen, JJ Venier, and JC Norris. 2014. “Effective sample size for computing prior hyperparameters in Bayesian phase I-II dose-finding.” <em>Clinical Trials</em> 11 (6): 657–66. doi:<a href="https://doi.org/10.1177/1740774514547397">10.1177/1740774514547397</a>.</p>
</div>
</div>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>The advice by the RStan team is that authors of packages that use RStan should provide static model files that are compiled when the package is installed.<a href="#fnref1">↩</a></p></li>
</ol>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#recap-of-the-efftox-model">Recap of the EffTox model</a></li>
      <li><a href="#efftox-in-trialr">EffTox in <code>trialr</code></a></li>
      <li>
<a href="#simulation">Simulation</a><ul class="nav nav-pills nav-stacked">
<li><a href="#simulation-speed">Simulation speed</a></li>
      </ul>
</li>
      <li><a href="#trialr">trialr</a></li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Kristian Brock.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
